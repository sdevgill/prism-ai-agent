{% extends "base.html" %}

{% block title %}Generate Assets · Prism AI Agent{% endblock %}

{% block content %}
    <section class="space-y-8">
        <header class="space-y-2">
            <h1 class="text-3xl font-semibold text-slate-900">Generate new assets</h1>
            <p class="text-sm text-slate-600">Share a webpage or paste raw copy. Prism cleans it up, then builds images, narration, and video guides that stay true to the source.</p>
        </header>

        <form method="post" action="{% url 'sources:ingest' %}" class="space-y-10">
            {% csrf_token %}

            <section class="space-y-4">
                <p class="text-xs font-semibold uppercase tracking-wide text-blue-600">Step 1</p>
                <h2 class="text-lg font-semibold text-slate-900">Name your run</h2>
                {% include 'partials/components/form_field.html' with field_id='run_title' label='Give this run a title' description='Use something descriptive so you can find these assets later.' required=True control_template='sources/partials/title_control.html' %}
            </section>

            <section class="space-y-4">
                <p class="text-xs font-semibold uppercase tracking-wide text-blue-600">Step 2</p>
                <h2 class="text-lg font-semibold text-slate-900">Choose how you will supply the content</h2>
                <fieldset class="space-y-4">
                    <legend class="text-sm font-semibold text-slate-700">How are you feeding the content?</legend>
                    <div class="flex flex-wrap gap-4 text-sm text-slate-600">
                        <label class="flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-4 py-2 shadow-sm focus-within:border-blue-500 cursor-pointer">
                            <input type="radio" name="input_mode" value="url" class="size-4 text-blue-600 focus:ring-blue-500" checked />
                            Website URL
                        </label>
                        <label class="flex items-center gap-2 rounded-lg border border-slate-300 bg-white px-4 py-2 shadow-sm focus-within:border-blue-500 cursor-pointer">
                            <input type="radio" name="input_mode" value="text" class="size-4 text-blue-600 focus:ring-blue-500" />
                            Pasted text
                        </label>
                    </div>
                </fieldset>
            </section>

            <section class="space-y-4">
                <p class="text-xs font-semibold uppercase tracking-wide text-blue-600">Step 3</p>
                <h2 class="text-lg font-semibold text-slate-900">Provide the source material</h2>
                <div class="space-y-6">
                    <div data-input-field="url">
                        {% include 'partials/components/form_field.html' with field_id='source_url' label='Website URL' description='Prism fetches the page, strips navigation chrome, and keeps the core story.' control_template='sources/partials/url_control.html' %}
                    </div>
                    <div data-input-field="text" class="hidden">
                        {% include 'partials/components/form_field.html' with field_id='source_text' label='Paste text' description='Drop in marketing copy, scripts, or notes (up to '|add:max_source_text_chars_display|add:' characters). Prism trims to roughly '|add:prompt_token_limit_display|add:' tokens before sending to the model.' control_template='sources/partials/text_control.html' %}
                    </div>
                </div>
            </section>

            <section class="space-y-4">
                <p class="text-xs font-semibold uppercase tracking-wide text-blue-600">Step 4</p>
                <h2 class="text-lg font-semibold text-slate-900">Pick the outputs</h2>
                <fieldset class="space-y-3">
                    <legend class="text-sm font-semibold text-slate-700">What should Prism generate?</legend>
                    <p class="text-xs text-slate-500">Pick one or more outputs. You can always rerun from the same source with different formats.</p>
                    {% with selected_modalities=form.modalities.value %}
                        <div class="space-y-2">
                            <label class="flex items-start gap-4 rounded-lg border border-slate-300 bg-white px-4 py-3 text-sm text-slate-700 shadow-sm focus-within:border-blue-500 cursor-pointer">
                                <input type="checkbox" name="modalities" value="image" class="mt-1 size-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500" data-modality-toggle="image" {% if selected_modalities and 'image' in selected_modalities %}checked{% endif %} />
                                <span class="flex h-10 w-10 items-center justify-center rounded-full bg-blue-100 text-blue-600">
                                    <i data-feather="image" class="h-5 w-5"></i>
                                </span>
                                <span>
                                    <span class="font-medium text-slate-800">Images <span class="text-xs font-normal text-slate-500">(up to 3 renders)</span></span>
                                    <p class="text-xs text-slate-500">Moodboard frames, key visuals, and cover art ideas.</p>
                                </span>
                            </label>
                            <label class="flex items-start gap-4 rounded-lg border border-slate-300 bg-white px-4 py-3 text-sm text-slate-700 shadow-sm focus-within:border-blue-500 cursor-pointer">
                                <input type="checkbox" name="modalities" value="audio" class="mt-1 size-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500" data-modality-toggle="audio" {% if selected_modalities and 'audio' in selected_modalities %}checked{% endif %} />
                                <span class="flex h-10 w-10 items-center justify-center rounded-full bg-blue-100 text-blue-600">
                                    <i data-feather="headphones" class="h-5 w-5"></i>
                                </span>
                                <span>
                                    <span class="font-medium text-slate-800">Audio <span class="text-xs font-normal text-slate-500">(1 narration)</span></span>
                                    <p class="text-xs text-slate-500">Narration comes back as an emotive Ash voice read, perfect for ~20 second radio spots.</p>
                                </span>
                            </label>
                            <label class="flex items-start gap-4 rounded-lg border border-slate-300 bg-white px-4 py-3 text-sm text-slate-700 shadow-sm focus-within:border-blue-500 cursor-pointer">
                                <input type="checkbox" name="modalities" value="video" class="mt-1 size-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500" {% if selected_modalities and 'video' in selected_modalities %}checked{% endif %} />
                                <span class="flex h-10 w-10 items-center justify-center rounded-full bg-blue-100 text-blue-600">
                                    <i data-feather="film" class="h-5 w-5"></i>
                                </span>
                                <span>
                                    <span class="font-medium text-slate-800">Video <span class="text-xs font-normal text-slate-500">(1 storyboard)</span></span>
                                    <p class="text-xs text-slate-500">Storyboard beats, shot prompts, and motion cues.</p>
                                </span>
                            </label>
                        </div>
                    {% endwith %}
                </fieldset>
            </section>

            <section id="image-options" class="space-y-3 rounded-lg border border-blue-100 bg-blue-50 px-4 py-3 text-sm text-blue-700 hidden" data-modality-options="image">
                <p class="text-xs font-semibold uppercase tracking-wide text-blue-600">Step 5</p>
                <h2 class="text-lg font-semibold text-blue-800">Fine-tune image output</h2>
                <p class="text-xs font-semibold uppercase tracking-wide text-blue-600">Image generation settings</p>
                <label class="flex flex-col gap-1">
                    <span class="text-xs font-medium uppercase tracking-wide">How many images?</span>
                    <select name="image_count" id="image_count" class="cursor-pointer rounded-md border border-blue-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200">
                        <option value="1" {% if form.image_count.value|stringformat:'s' == '1' %}selected{% endif %}>1 image</option>
                        <option value="2" {% if form.image_count.value|stringformat:'s' == '2' %}selected{% endif %}>2 images</option>
                        <option value="3" {% if form.image_count.value|stringformat:'s' == '3' or not form.image_count.value %}selected{% endif %}>3 images</option>
                    </select>
                    {% if form.image_count.errors %}
                        <p class="text-xs text-red-600">{{ form.image_count.errors|join:', ' }}</p>
                    {% endif %}
                </label>
                <label class="flex flex-col gap-1">
                    <span class="text-xs font-medium uppercase tracking-wide">Quality</span>
                    <select name="image_quality" id="image_quality" class="cursor-pointer rounded-md border border-blue-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200">
                        <option value="low" {% if form.image_quality.value == 'low' %}selected{% endif %}>Low (fast, rough ideation)</option>
                        <option value="medium" {% if form.image_quality.value == 'medium' or not form.image_quality.value %}selected{% endif %}>Medium (balanced)</option>
                        <option value="high" {% if form.image_quality.value == 'high' %}selected{% endif %}>High (maximum fidelity)</option>
                    </select>
                    {% if form.image_quality.errors %}
                        <p class="text-xs text-red-600">{{ form.image_quality.errors|join:', ' }}</p>
                    {% endif %}
                </label>
                <label class="flex flex-col gap-1">
                    <span class="text-xs font-medium uppercase tracking-wide">Dimensions</span>
                    <select name="image_size" id="image_size" class="cursor-pointer rounded-md border border-blue-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-200">
                        <option value="1024x1024" {% if form.image_size.value == '1024x1024' %}selected{% endif %}>Square - 1024×1024</option>
                        <option value="1024x1536" {% if form.image_size.value == '1024x1536' or not form.image_size.value %}selected{% endif %}>Portrait - 1024×1536 (default)</option>
                        <option value="1536x1024" {% if form.image_size.value == '1536x1024' %}selected{% endif %}>Landscape - 1536×1024</option>
                    </select>
                    {% if form.image_size.errors %}
                        <p class="text-xs text-red-600">{{ form.image_size.errors|join:', ' }}</p>
                    {% endif %}
                </label>
                <p class="text-xs text-blue-600">GPT-Image-1 supports 1–3 renders per call and quality tiers Low/Medium/High. Pick what fits your brief.</p>
                <p class="text-xs text-blue-600">Size options map to GPT-Image-1’s supported 1024 and 1536 combinations.</p>
            </section>

            <section id="audio-options" class="space-y-3 rounded-lg border border-purple-100 bg-purple-50 px-4 py-3 text-sm text-purple-700 hidden" data-modality-options="audio">
                <p class="text-xs font-semibold uppercase tracking-wide text-purple-600">Step 6</p>
                <h2 class="text-lg font-semibold text-purple-800">Tune the narration</h2>
                <p class="text-xs font-semibold uppercase tracking-wide text-purple-600">Audio generation settings</p>
                <label class="flex flex-col gap-1">
                    <span class="text-xs font-medium uppercase tracking-wide">Voice preset</span>
                    <select name="audio_voice" id="audio_voice" class="cursor-pointer rounded-md border border-purple-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-200">
                        <option value="ash" data-voice-label="Ash" data-voice-detail="like a warm radio spot" {% if form.audio_voice.value == 'ash' or not form.audio_voice.value %}selected{% endif %}>Ash - Warm radio delivery</option>
                        <option value="nova" data-voice-label="Nova" data-voice-detail="clean and modern" {% if form.audio_voice.value == 'nova' %}selected{% endif %}>Nova - Crisp storyteller</option>
                        <option value="ballad" data-voice-label="Ballad" data-voice-detail="with an adventurous British edge" {% if form.audio_voice.value == 'ballad' %}selected{% endif %}>Ballad - Adventurous British tone</option>
                    </select>
                    {% if form.audio_voice.errors %}
                        <p class="text-xs text-red-600">{{ form.audio_voice.errors|join:', ' }}</p>
                    {% endif %}
                </label>
                <label class="flex flex-col gap-1">
                    <span class="text-xs font-medium uppercase tracking-wide">Output format</span>
                    <select name="audio_format" id="audio_format" class="cursor-pointer rounded-md border border-purple-200 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-200">
                        <option value="mp3" {% if form.audio_format.value == 'mp3' or not form.audio_format.value %}selected{% endif %}>MP3 (small file)</option>
                        <option value="wav" {% if form.audio_format.value == 'wav' %}selected{% endif %}>WAV (lossless)</option>
                    </select>
                    {% if form.audio_format.errors %}
                        <p class="text-xs text-red-600">{{ form.audio_format.errors|join:', ' }}</p>
                    {% endif %}
                </label>
                <p class="text-xs text-purple-600">We prime the <span data-audio-voice-label>Ash</span> voice with the system guidance "Speak in an emotive and friendly tone." so the read lands <span data-audio-voice-detail>like a warm radio spot</span>.</p>
            </section>

            <aside class="rounded-lg border border-blue-100 bg-blue-50 px-4 py-3 text-sm text-blue-700">
                <h2 class="font-semibold text-blue-800">Quick heads-up</h2>
                <ul class="mt-2 space-y-1 text-xs text-blue-700">
                    <li>• Prism shows progress live once the backend hooks in.</li>
                    <li>• You’ll find every output in the Assets page grouped by source.</li>
                    <li>• Need to iterate? Re-run with the same link and different formats.</li>
                </ul>
            </aside>

            <div class="flex flex-wrap items-center justify-center gap-3">
                {% include 'partials/components/button.html' with label='Generate assets' type='submit' %}
                {% include 'partials/components/button.html' with label='Clear fields' type='reset' variant='ghost' %}
            </div>
        </form>

        <section id="generate-status" class="space-y-4" aria-live="polite">
            {% if status_url %}
                <div class="rounded-xl border border-dashed border-slate-300 bg-white px-4 py-6 text-sm text-slate-500">
                    Starting assets generation...
                </div>
            {% endif %}
        </section>
    </section>
{% endblock %}

{% block extra_scripts %}
    {{ block.super }}
    <script>
        (function () {
            const modeInputs = document.querySelectorAll('input[name="input_mode"]');
            const urlField = document.getElementById('source_url');
            const textField = document.getElementById('source_text');
            const urlWrapper = document.querySelector('[data-input-field="url"]');
            const textWrapper = document.querySelector('[data-input-field="text"]');
            const charCounter = document.querySelector('[data-char-count]');
            const tokenCounter = document.querySelector('[data-token-count]');
            const modalityToggles = document.querySelectorAll('[data-modality-toggle]');
            const modalityOptionSections = document.querySelectorAll('[data-modality-options]');
            const audioVoiceSelect = document.getElementById('audio_voice');
            const audioVoiceLabel = document.querySelector('[data-audio-voice-label]');
            const audioVoiceDetail = document.querySelector('[data-audio-voice-detail]');
            const statusUrl = '{{ status_url|default:""|escapejs }}';
            const statusContainer = document.getElementById('generate-status');
            const csrfInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
            const tokenEndpoint = '{% url "sources:token-estimate" %}';

            if (!modeInputs.length || !urlField || !textField || !urlWrapper || !textWrapper || !charCounter || !tokenCounter) {
                return;
            }

            const charLimit = Number(textField.dataset.charLimit || {{ max_source_text_chars }});
            const tokenLimit = Number(textField.dataset.tokenLimit || {{ prompt_token_limit }});
            const formatNumber = (value) => new Intl.NumberFormat().format(value);
            let tokenTimeoutId;
            let tokenAbortController;

            const updateTokenDisplay = (tokens) => {
                tokenCounter.textContent = `${formatNumber(tokens)}/${formatNumber(tokenLimit)} tokens`;
                const tokenOverLimit = tokens > tokenLimit;
                tokenCounter.classList.toggle('text-rose-600', tokenOverLimit);
                tokenCounter.classList.toggle('text-slate-500', !tokenOverLimit);
            };

            const requestTokenCount = (value) => {
                if (!tokenEndpoint) {
                    return;
                }

                if (tokenAbortController) {
                    tokenAbortController.abort();
                }

                tokenAbortController = new AbortController();

                fetch(tokenEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                        'X-CSRFToken': csrfInput ? csrfInput.value : '',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    body: new URLSearchParams({ text: value }).toString(),
                    credentials: 'same-origin',
                    signal: tokenAbortController.signal,
                })
                    .then((response) => (response.ok ? response.json() : Promise.reject()))
                    .then((data) => {
                        if (typeof data.tokens === 'number') {
                            updateTokenDisplay(data.tokens);
                        }
                    })
                    .catch(() => {
                        // Swallow errors; next input event will retry.
                    });
            };

            const scheduleTokenRequest = (value) => {
                if (tokenTimeoutId) {
                    window.clearTimeout(tokenTimeoutId);
                }
                if (!value.trim()) {
                    if (tokenAbortController) {
                        tokenAbortController.abort();
                    }
                    updateTokenDisplay(0);
                    return;
                }

                tokenTimeoutId = window.setTimeout(() => requestTokenCount(value), 200);
            };

            const updateCounts = () => {
                const value = textField.value || '';
                const charCount = value.length;

                charCounter.textContent = `${formatNumber(charCount)}/${formatNumber(charLimit)} characters`;

                const charOverLimit = charCount > charLimit;

                charCounter.classList.toggle('text-rose-600', charOverLimit);
                charCounter.classList.toggle('text-slate-500', !charOverLimit);

                scheduleTokenRequest(value);
            };

            const toggleFields = () => {
                const selected = document.querySelector('input[name="input_mode"]:checked');
                const mode = selected ? selected.value : 'url';

                if (mode === 'text') {
                    urlWrapper.classList.add('hidden');
                    textWrapper.classList.remove('hidden');
                    urlField.removeAttribute('required');
                    textField.setAttribute('required', 'required');
                } else {
                    textWrapper.classList.add('hidden');
                    urlWrapper.classList.remove('hidden');
                    textField.removeAttribute('required');
                    urlField.setAttribute('required', 'required');
                }

                updateCounts();
            };

            modeInputs.forEach((input) => {
                input.addEventListener('change', toggleFields);
            });

            textField.addEventListener('input', updateCounts);

            toggleFields();

            const syncAudioVoiceLabel = () => {
                if (!audioVoiceSelect || !audioVoiceLabel) {
                    return;
                }
                const option = audioVoiceSelect.options[audioVoiceSelect.selectedIndex];
                if (option) {
                    const humanLabel = option.dataset.voiceLabel || option.textContent.split(' · ')[0].trim() || option.textContent.split('-')[0].trim();
                    const detailLabel = option.dataset.voiceDetail || audioVoiceLabel?.textContent || '';
                    if (audioVoiceLabel) {
                        audioVoiceLabel.textContent = humanLabel;
                    }
                    if (audioVoiceDetail) {
                        audioVoiceDetail.textContent = detailLabel;
                    }
                }
            };

            const syncModalityOptions = () => {
                if (!modalityOptionSections.length) {
                    return;
                }
                modalityOptionSections.forEach((section) => {
                    const modality = section.getAttribute('data-modality-options');
                    const selector = modality ? '[data-modality-toggle="' + modality + '"]' : null;
                    const toggle = selector ? document.querySelector(selector) : null;
                    if (toggle && toggle.checked) {
                        section.classList.remove('hidden');
                    } else {
                        section.classList.add('hidden');
                    }
                });
                syncAudioVoiceLabel();
            };

            modalityToggles.forEach((toggle) => {
                toggle.addEventListener('change', syncModalityOptions);
            });

            syncModalityOptions();

            if (audioVoiceSelect) {
                audioVoiceSelect.addEventListener('change', syncAudioVoiceLabel);
                syncAudioVoiceLabel();
            }

            const pollStatus = (url) => {
                if (!url || !statusContainer) {
                    return;
                }

                fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'HX-Request': 'true',
                    },
                    credentials: 'same-origin',
                })
                    .then((response) => (response.ok ? response.text() : Promise.reject()))
                    .then((html) => {
                        statusContainer.innerHTML = html;
                        if (typeof window.refreshFeatherIcons === 'function') {
                            window.refreshFeatherIcons();
                        }

                        const root = statusContainer.querySelector('[data-poll-active]');
                        const shouldContinue = root && root.dataset.pollActive === 'true';

                        if (shouldContinue) {
                            window.setTimeout(() => pollStatus(url), 3000);
                        }
                    })
                    .catch(() => {
                        statusContainer.innerHTML = '<div class="rounded-xl border border-red-200 bg-red-50 px-4 py-4 text-sm text-red-700">We could not load live status. Refresh the page to try again.</div>';
                    });
            };

            if (statusUrl && statusContainer) {
                pollStatus(statusUrl);
            }
        })();
    </script>
{% endblock %}
